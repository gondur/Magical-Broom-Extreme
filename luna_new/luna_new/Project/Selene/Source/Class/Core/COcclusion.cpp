

//-----------------------------------------------------------------------------------
// INCLUDE
//-----------------------------------------------------------------------------------
#include "Base.h"		// PCH

#include "Core/CDevice.h"
#include "Core/COcclusion.h"


//-----------------------------------------------------------------------------------
// NAMESPACE
//-----------------------------------------------------------------------------------
using namespace Selene;


//-----------------------------------------------------------------------------------
/**
*/
//-----------------------------------------------------------------------------------
COcclusion::COcclusion( CDevice *pDevice )
	: m_pQuery	( NULL )
{
	pDevice->CreateOcclusionQuery( &m_pQuery );
}

//-----------------------------------------------------------------------------------
/**
*/
//-----------------------------------------------------------------------------------
COcclusion::~COcclusion()
{
	SAFE_RELEASE( m_pQuery );
}

//-----------------------------------------------------------------------------------
/**
*/
//-----------------------------------------------------------------------------------
void COcclusion::Begin( void )
{
	if ( m_pQuery != NULL )
	{
		m_pQuery->Issue( D3DISSUE_BEGIN );

	}
}

//-----------------------------------------------------------------------------------
/**
*/
//-----------------------------------------------------------------------------------
void COcclusion::End( void )
{
	if ( m_pQuery != NULL )
	{
		m_pQuery->Issue( D3DISSUE_END );
	}
}

//-----------------------------------------------------------------------------------
/**
*/
//-----------------------------------------------------------------------------------
Uint32 COcclusion::GetPixels( void )
{
	if ( m_pQuery != NULL )
	{
		Uint32 PixelsVisible = 0;
		while ( FAILED( m_pQuery->GetData( (void*)&PixelsVisible, sizeof(Uint32), D3DGETDATA_FLUSH ) ) );
		return PixelsVisible;
	}

	return 0xFFFFFFFF;
}

